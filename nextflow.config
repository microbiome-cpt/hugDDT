// nextflow.config: Configuration for metagenomics pipeline

manifest {
    name = 'Metagenomics Pipeline'
    author = 'Your Name'
    description = 'A comprehensive Nextflow pipeline for metagenomic analysis'
    version = '1.0.0'
    nextflowVersion = '>=22.10.0'
}

workDir = '/mnt/raid0/Toxins/work_nf'
// Default parameters
params {
    // Input data
    input_ont = null         // Path to Nanopore FASTQ directory
    input_pod = null      // Path to Nanopore raw .pod5 directory
    input_short = null
    pattern_short = '*R{1,2}*.{fastq,fq,fastq.gz,fq.gz}'
    databases = '/mnt/raid0/Databases/DDTdb'        // Path to folder with all databases

    ku_index = '/mnt/raid0/Databases/DDTdb/krakenuniq_db'
    kaiju_index = '/mnt/raid0/Databases/DDTdb/kaiju_db_refseq'
    cfg_index = '/mnt/raid0/Databases/DDTdb/centrifiger_db/cfr_hpv+gbsarscov2'
    metamaps_index = '/mnt/raid0/Databases/DDTdb/databases/miniSeq+H'
    homopolish_sketch = '/mnt/raid0/Databases/DDTdb/homop_sketch/bacteria.msh'
    checkm2_index = '/mnt/raid0/Databases/DDTdb/CheckM2_database/uniref100.KO.1.dmnd'
    diamond_index = ''
    megan_index = ''
    gtdb_index = '/mnt/raid0/Databases/DDTdb/release226'

    cpus = 250
    mem = '900 GB'

    outdir = 'results'
    //reports = 'reports'
    raw_data = '${params.outdir}/raw'

    // Dorado parameters
    dorado_model = 'dna_r10.4.1_e8.2_400bps_sup@v4.2.0'  // Default model for R10.4.1 kit
    demultiplex = false     // Enable demultiplexing
    barcode_kit = null      // Barcode kit (e.g., 'SQK-NBD114-24')
    detect_modifications = false  // Enable modified base detection
    modification_model = null     // Model for modification detection (e.g., '5mC@v2')
    duplex = false          // Enable duplex sequencing processing
    dorado_opts = ''        // Additional Dorado options

    // Tool-specific parameters
    porechop_opts = '--no_split'
    chopper_opts = '-q 10 -l 1000 --maxlength 100000'
    fastp_opts = ''
    fmlrc2_opts = ''
    krakenuniq_opts = '--preload '
    kaiju_opts = ''
    centrifuge_opts = ''
    diamond_opts = ''
    megan_opts = ''
    flye_opts = ''
    raven_opts = ''
    spades_opts = ''
    minimap2_opts = ''
    racon_opts = '-m 8 -x -6 -g -8'
    racon_rounds = '2'
    medaka_opts = '--bacteria'
    pilon_opts = ''
    homopolish_opts = '-m /mnt/raid0/Databases/DDTdb/homop_sketch/R10.3.pkl --meta'
    quast_opts = '--max-ref-number 0 --gene-finding'
    semibin_opts = '--environment human_gut --compression none -r /mnt/raid0/Databases/DDTdb/release226 --sequencing-type long_read '
    metabinner_opts = ''
    comebin_opts = ''
    metawrap_opts = ''
    gtdbtk_opts = '-x .fa'
    abricate_opts = ''
    prokka_opts = ''
    genomad_opts = ''
    taxpasta_opts = ''
    checkm2_opts = '--specific --force'
    coverm_opts = ''
    merqury_opts = ''
    reapr_opts = ''
    metamaps_opts = ''
    // Feature flags
    help = false
    hybrid = false
    read_expand = false
    polybin = false
    annotate_more = false
    prokka = false
}

// Process resource configurations
process {
    // Default configuration - use all specified resources
    cpus = params.cpus
    memory = params.mem
    
    // Resource labels for specific needs
    withLabel: small_mem {
        cpus = { Math.min(4, params.cpus as int) }
        memory = { 
            def requestedGB = (params.mem as String).replaceAll(/[^0-9]/, '') as int
            "${Math.min(8, requestedGB)}GB"
        }
    }

    // Container configurations - only required ones
    withName: 'METABINNER|COMEBIN' {
        container = 'quay.io/biocontainers/metabinner:1.4.4--hdfd78af_0'
    }
    
    withName: 'MEGAN_LR' {
        container = 'quay.io/biocontainers/megan:6.21.7--hdfd78af_0'
    }
}

// Profiles
profiles {
    standard {
        process.executor = 'local'
    }
    
    slurm {
        process.executor = 'slurm'
    }
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
    }
    
    conda {
        conda.enabled = true
    }
} 

// Reporting
report {
    enabled = true
//   overwrite = true
//    file = "${params.outdir}/execution/report_<timestamp>.html"
}

timeline {
    enabled = true
//    overwrite = true
//    file = "${params.outdir}/execution/timeline_<timestamp>.html"
}

trace {
    enabled = true
//    overwrite = true
//    file = "${params.outdir}/execution/trace_<timestamp>.txt"
}

//workflow.onComplete = {
//    log.info "Pipeline completed at: $workflow.complete"
//    log.info "Execution status: ${ workflow.success ? 'OK' : 'failed' }"
//    log.info "Execution duration: $workflow.duration"
//} 

//cleanup = true
